$(document).ready(function(){function l(e,t){var n=this.getBBox();var r=d3.select(this.parentNode).append("svg:rect").attr("x",n.x).attr("y",n.y).attr("width",n.width).attr("height",n.height).style("fill","#ccc").style("fill-opacity",".3").style("stroke","#111").style("stroke-width","0.3px");e.topTextHeight=n.height}function c(e,t){var n=this.getBBox();var r=d3.select(this.parentNode).append("svg:rect").attr("x",n.x).attr("y",n.y).attr("width",n.width).attr("height",n.height).style("fill","#ccc").style("fill-opacity",".3").style("stroke","#111").style("stroke-width","0.3px");e.downTextHeight=n.height}function h(e){var t=200;var n=u.nodes(e).reverse();var r=u.links(n);var h=0;n.forEach(function(e){e.y+=i;if(e.x<h){h=e.x}});n.forEach(function(e,t){e.x+=-h});var v=f.selectAll("g.node").data(n,function(e,t){return e.id});var m=v.enter().append("svn:g").attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"});var g=m.append("g").attr("class","node_info").on("click",function(e){alert(e.id+" : "+e.image+" clicked")});g.append("image").attr("xlink:href",function(e){return"images/"+e.image}).attr("x",-s/2).attr("y",-i/2).attr("width",s).attr("height",i);g.filter(function(e){return e.title}).append("text").attr("dx",0).attr("dy",-(i/2+4)).style("text-anchor","middle").text(function(e){return e.title}).each(l);g.filter(function(e){return e.description}).append("text").attr("dx",0).attr("dy",i/2+10).style("text-anchor","middle").html(function(e){return e.description}).each(c);var y=m.filter(function(e){return!e.children}).append("g").attr("class","node_new");y.filter(function(e){return!e.children}).append("svg:line").attr("class","link_new").attr("id",function(e){return"link_"+e.id+"_new"}).attr("style",function(e){var t=e.image;return"stroke: "+d(t)+";"}).attr("y1",0).attr("y1",function(e){return i/2+(e.downTextHeight||0)}).attr("x2",0).attr("y2",function(e){return o+i/2});y.filter(function(e){return!e.children}).append("image").attr("xlink:href","images/add_node.png").attr("x",-9).attr("y",o+i/2).attr("width",18).attr("height",18).attr("class","add_node").on("click",function(e){p(e,null)});var b=v.transition().duration(t).attr("transform",function(e){return"translate("+e.x+","+e.y+")"});v.selectAll("g.node_new").filter(function(e){return e.children}).transition().duration(t).remove();var w=v.exit().transition().duration(t).remove();var E=f.selectAll(".link").data(r,function(e,t){return e.source.id+"-"+e.target.id});E.enter().append("svg:path").attr("class","link").attr("id",function(e){return"link_"+e.source.id+"_"+e.target.id}).attr("style",function(e){var t=e.source.image;return"stroke: "+d(t)+";"}).attr("d",a);E.transition().duration(t).attr("d",a);E.exit().transition().remove();var S=f.selectAll("g.add_node_link").data(r,function(e){return e.source.id+"-"+e.target.id});S.enter().append("svg:g").attr("class","add_node add_node_link").attr("transform",function(e){return"translate("+((e.target.x+e.source.x)/2-9)+","+((e.target.y+e.source.y)/2-9)+")"}).append("image").attr("xlink:href","images/add_node.png").attr("id",function(e){return"add_node_to_"+e.source.id}).attr("x",0).attr("y",0).attr("width",18).attr("height",18).on("click",function(e){p(e.source,e.target)});S.transition().duration(t).attr("transform",function(e){return"translate("+((e.target.x+e.source.x)/2-9)+","+((e.target.y+e.source.y)/2-9)+")"});S.exit().remove()}function p(e,t){var i=!t||d3.event.altKey?false:true;var s=["dtmf.png","call.png","call_link.png","check_direction.png","goto.png","goto_tree.png"];d3.shuffle(s);var o={id:"new_"+n++,image:s.shift(),children:[]};if(!e.children){e.children=[]}if(!i){e.children.push(o)}else{o.children.push(t);e.children.forEach(function(n,r){if(n.id==t.id){e.children[r]=o}})}h(r)}function d(e){if("check_direction.png"==e){return"#E65639"}else if("dtmf.png"==e){return"#E9C831"}else if("goto.png"==e||"goto_tree.png"==e){return"#6CBE35"}else{return"#2A98D0"}}var e=1200,t=3e3;var n=1;var r;var i=68,s=68;var o=20;var u=d3.layout.tree().nodeSize([100,180]);var a=d3.svg.diagonal().source(function(e){return{x:e.source.x,y:e.source.y+i/2+(e.source.downTextHeight||0)}}).target(function(e){return{x:e.target.x,y:e.target.y-i/2-(e.target.topTextHeight||0)}});var f=d3.select("#chart-inner").append("svg:svg").attr("width",e).attr("height",t).append("svg:g").attr("transform","translate(40, 0)");d3.json("data.json",function(e,t){r=t;h(r)})})